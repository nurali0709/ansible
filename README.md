
# Ansible Playbook для деплоя веб-приложения (Nginx, PHP, MySQL) с Docker и Docker Compose

Этот проект включает Ansible playbook и роли для автоматизированного деплоя веб-приложения, использующего Nginx, PHP и MySQL, на удалённый сервер. Приложение запускается в Docker-контейнерах с использованием `docker-compose`.

## Содержание

- [Требования](#требования)
- [Структура проекта](#структура-проекта)
- [Переменные](#переменные)
- [Установка и использование](#установка-и-использование)
  - [Шаг 1: Настройка окружения](#шаг-1-настройка-окружения)
  - [Шаг 2: Настройка переменных](#шаг-2-настройка-переменных)
  - [Шаг 3: Запуск плейбука](#шаг-3-запуск-плейбука)
- [Роли](#роли)
- [Файлы](#файлы)
- [Примечания](#примечания)

## Требования

Для работы с данным проектом вам потребуется:

- Ansible 2.10+
- Доступ к удалённому серверу с установленным Python 3
- Пользователь с правами `sudo` на удалённом сервере
- Установленный Docker и Docker Compose на вашем локальном компьютере для тестирования

### Описание файлов

- `playbook.yml` – главный playbook, который запускает роли.
- `roles/` – содержит три роли:
  - `docker` – установка Docker и Docker Compose на удалённый сервер.
  - `nginx` – настройка и перезапуск Nginx с генерацией конфигурации.
  - `app_deploy` – деплой приложения с использованием `docker-compose`.
- `files/` – содержит файлы для `docker-compose` и `Dockerfile`.
- `group_vars/all.yml` – содержит глобальные переменные для настройки приложения, такие как учётные данные MySQL.
- `inventories/production` – инвентарь серверов для продакшена.

## Переменные

Файл переменных `group_vars/all.yml` содержит следующие значения, которые могут быть изменены:

```yaml
mysql_root_password: supersecurepassword  # Пароль для root пользователя MySQL
mysql_database: my_app_db                 # Имя базы данных
mysql_user: app_user                      # Пользователь базы данных
mysql_password: securepassword            # Пароль для пользователя базы данных
```

Вы можете изменить эти значения перед запуском плейбука для настройки базы данных под ваше окружение.

## Установка и использование

### Шаг 1: Настройка окружения

1. Установите [Ansible](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html) на ваш локальный компьютер.
2. Убедитесь, что у вас есть доступ к удалённому серверу с правами `sudo`.
3. Убедитесь, что на удалённом сервере установлен Python 3.

### Шаг 2: Настройка переменных

1. Откройте файл `group_vars/all.yml` и укажите значения для базы данных MySQL.
2. Убедитесь, что ваш инвентарь серверов настроен правильно в `inventories/production`. Например:

```ini
[webservers]
your_server_ip ansible_user=your_user ansible_ssh_private_key_file=~/.ssh/id_rsa
```

### Шаг 3: Запуск плейбука

Для запуска плейбука используйте следующую команду:

```bash
ansible-playbook -i inventories/production playbook.yml
```

Ansible выполнит следующие шаги:

1. Установит Docker и Docker Compose, если они ещё не установлены.
2. Скопирует конфигурационные файлы (например, `docker-compose.yml`, `Dockerfile`) на удалённый сервер.
3. Сгенерирует и применит конфигурацию Nginx.
4. Запустит приложение с помощью `docker-compose`.

## Роли

### Роль `docker`

Устанавливает Docker и Docker Compose на удалённый сервер.

- Устанавливает Docker через `apt`.
- Скачивает и устанавливает последнюю версию Docker Compose для указанной архитектуры.

### Роль `nginx`

Генерирует конфигурацию Nginx и перезапускает сервис, если конфигурация была изменена.

- Копирует конфигурацию Nginx с использованием шаблона `nginx.conf.j2`.
- Проверяет конфигурацию перед перезагрузкой Nginx, чтобы избежать падения сервиса.
- Убедитесь, что Nginx запущен и настроен правильно.

### Роль `app_deploy`

Копирует `docker-compose.yml` и `Dockerfile`, затем запускает или обновляет приложение с помощью Docker Compose.

- Создаёт директорию `/opt/myapp` на удалённом сервере.
- Копирует необходимые файлы для Docker Compose и Dockerfile.
- Запускает приложение через `docker-compose up -d`.

## Примечания

- **Безопасность:** Не забудьте изменить пароли и другие конфиденциальные данные в `group_vars/all.yml`.
- **Тестирование:** Рекомендуется тестировать на staging-сервере перед деплоем в production.
- **Поддержка:** Вы можете легко модифицировать роли и шаблоны для поддержки других версий PHP, MySQL или других сервисов.

---
